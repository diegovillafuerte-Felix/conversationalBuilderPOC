{
  "id": "remittances",
  "name": "Remittances Agent",
  "description": "I'm the Felix remittances specialist. I can help you with:\n- Sending money to Mexico and Latin America (MX, GT, HN, CO, DO, SV, NI)\n- Checking current exchange rates\n- Viewing the status of your previous transfers\n- Managing your saved recipients\n\nRemittances typically arrive in 2-4 hours and fees start at $3.99 USD.",
  "system_prompt_addition": "IMMEDIATE ACTIONS:\n- When user wants to send money → start_flow_send_money\n- When user mentions a new recipient name → start_flow_add_recipient\n- When user says 'send again' or mentions recent transfer → start_flow_quick_send\n\nDo NOT collect information manually - use flows which guide the conversation step by step.\n\nFor information queries (rate, status, history, limits), use the appropriate info tools directly.",
  "default_tools": [
    "start_flow_send_money",
    "start_flow_add_recipient",
    "start_flow_quick_send",
    "get_exchange_rate",
    "list_recipients",
    "list_transfers"
  ],
  "model_config": {
    "model": "gpt-5.2",
    "temperature": 0.3,
    "maxTokens": 1024
  },
  "navigation": {
    "canGoUp": true,
    "canGoHome": true,
    "canEscalate": true
  },
  "parent_agent": "felix",
  "tools": [
    {
      "name": "start_flow_send_money",
      "description": "Start the send money flow to guide the user through sending a remittance.",
      "parameters": [],
      "side_effects": "flow",
      "requires_confirmation": false,
      "starts_flow": "send_money_flow"
    },
    {
      "name": "start_flow_add_recipient",
      "description": "Start the flow to add a new recipient.",
      "parameters": [],
      "side_effects": "flow",
      "requires_confirmation": false,
      "starts_flow": "add_recipient_flow"
    },
    {
      "name": "start_flow_quick_send",
      "description": "Start the quick send flow to repeat a recent transfer.",
      "parameters": [],
      "side_effects": "flow",
      "requires_confirmation": false,
      "starts_flow": "quick_send_flow"
    },
    {
      "name": "start_flow_snpl_remittance",
      "description": "Start SNPL-funded remittance flow. Use when user has approved SNPL credit and wants to send money using that credit. Amount and payment are already handled by SNPL.",
      "parameters": [
        {
          "name": "loan_id",
          "type": "string",
          "required": true,
          "description": "The SNPL loan ID funding this transfer"
        },
        {
          "name": "amount_usd",
          "type": "number",
          "required": true,
          "description": "Amount to send (from SNPL loan)"
        }
      ],
      "side_effects": "flow",
      "requires_confirmation": false,
      "starts_flow": "snpl_remittance_flow"
    },
    {
      "name": "get_exchange_rate",
      "description": "Checks the current exchange rate for transfers to a specific country.",
      "parameters": [
        {
          "name": "country",
          "type": "string",
          "required": false,
          "description": "Country code (MX, GT, HN, CO, DO, SV, NI). Default MX."
        }
      ],
      "side_effects": "read",
      "requires_confirmation": false
    },
    {
      "name": "list_recipients",
      "description": "Gets the user's saved recipients list.",
      "parameters": [
        {
          "name": "country",
          "type": "string",
          "required": false,
          "description": "Filter by country code (MX, GT, HN, CO, DO, SV, NI)."
        }
      ],
      "side_effects": "read",
      "requires_confirmation": false
    },
    {
      "name": "get_recipient",
      "description": "Gets details for a specific recipient.",
      "parameters": [
        {
          "name": "recipient_id",
          "type": "string",
          "required": true,
          "description": "The recipient's ID."
        }
      ],
      "side_effects": "read",
      "requires_confirmation": false
    },
    {
      "name": "get_delivery_methods",
      "description": "Gets available delivery methods for a country (bank, cash, wallet, debit).",
      "parameters": [
        {
          "name": "country",
          "type": "string",
          "required": true,
          "description": "Country code (MX, GT, HN, CO, DO, SV, NI)."
        }
      ],
      "side_effects": "read",
      "requires_confirmation": false
    },
    {
      "name": "get_user_limits",
      "description": "Gets the user's sending limits based on their KYC level.",
      "parameters": [],
      "side_effects": "read",
      "requires_confirmation": false
    },
    {
      "name": "get_transfer_status",
      "description": "Checks the status of a specific transfer.",
      "parameters": [
        {
          "name": "transfer_id",
          "type": "string",
          "required": true,
          "description": "The transfer ID to check."
        }
      ],
      "side_effects": "read",
      "requires_confirmation": false
    },
    {
      "name": "list_transfers",
      "description": "Gets the user's recent transfer history.",
      "parameters": [
        {
          "name": "limit",
          "type": "number",
          "required": false,
          "description": "Maximum number of transfers to show. Default 5."
        },
        {
          "name": "status",
          "type": "string",
          "required": false,
          "description": "Filter by status (COMPLETED, PROCESSING, CANCELLED)."
        }
      ],
      "side_effects": "read",
      "requires_confirmation": false
    },
    {
      "name": "create_quote",
      "description": "Creates a full quote with fees, exchange rate, and amount recipient will receive.",
      "parameters": [
        {
          "name": "amount_usd",
          "type": "number",
          "required": true,
          "description": "Amount to send in USD."
        },
        {
          "name": "country",
          "type": "string",
          "required": false,
          "description": "Destination country code. Default MX."
        },
        {
          "name": "delivery_type",
          "type": "string",
          "required": false,
          "description": "Delivery method (BANK, CASH, WALLET, DEBIT). Default BANK."
        }
      ],
      "side_effects": "read",
      "requires_confirmation": false
    },
    {
      "name": "create_transfer",
      "description": "Creates and executes a remittance transfer.",
      "parameters": [
        {
          "name": "recipient_id",
          "type": "string",
          "required": true,
          "description": "The recipient's ID."
        },
        {
          "name": "amount_usd",
          "type": "number",
          "required": true,
          "description": "Amount to send in USD."
        },
        {
          "name": "delivery_method_id",
          "type": "string",
          "required": false,
          "description": "Specific delivery method ID. Uses default if not provided."
        },
        {
          "name": "payment_method_id",
          "type": "string",
          "required": false,
          "description": "Payment method ID to use."
        }
      ],
      "requires_confirmation": true,
      "confirmation_template": "Confirm sending ${amount_usd} USD to {recipient_name}?\n\nThey will receive the equivalent in {currency}\nWill be charged to your default payment method\nEstimated arrival: {eta}",
      "side_effects": "financial",
      "flow_transition": {
        "onSuccess": "completed",
        "onError": "error_state"
      }
    },
    {
      "name": "cancel_transfer",
      "description": "Cancels a pending transfer if eligible.",
      "parameters": [
        {
          "name": "transfer_id",
          "type": "string",
          "required": true,
          "description": "The transfer ID to cancel."
        }
      ],
      "requires_confirmation": true,
      "confirmation_template": "Cancel transfer {transfer_id}?\n\nRefund will arrive in 3-5 business days.",
      "side_effects": "financial"
    },
    {
      "name": "create_snpl_transfer",
      "description": "Creates a remittance transfer funded by SNPL credit. No additional payment needed.",
      "parameters": [
        {
          "name": "snpl_loan_id",
          "type": "string",
          "required": true,
          "description": "The SNPL loan ID funding this transfer"
        },
        {
          "name": "recipient_id",
          "type": "string",
          "required": true,
          "description": "The recipient's ID"
        },
        {
          "name": "amount_usd",
          "type": "number",
          "required": true,
          "description": "Amount to send in USD (from SNPL loan)"
        },
        {
          "name": "delivery_method_id",
          "type": "string",
          "required": false,
          "description": "Specific delivery method ID. Uses default if not provided."
        }
      ],
      "requires_confirmation": true,
      "confirmation_template": "Confirm sending ${amount_usd} USD to {recipient_name} using your SNPL credit?\n\nThey will receive the equivalent in {currency}\nFunded by: SNPL Loan {snpl_loan_id}",
      "side_effects": "financial",
      "flow_transition": {
        "onSuccess": "completed",
        "onError": "error_state"
      }
    },
    {
      "name": "save_recipient",
      "description": "Saves a new recipient with their delivery method.",
      "parameters": [
        {
          "name": "first_name",
          "type": "string",
          "required": true,
          "description": "Recipient's first name."
        },
        {
          "name": "last_name",
          "type": "string",
          "required": true,
          "description": "Recipient's last name."
        },
        {
          "name": "country",
          "type": "string",
          "required": true,
          "description": "Country code (MX, GT, HN, CO, DO, SV, NI)."
        },
        {
          "name": "delivery_type",
          "type": "string",
          "required": true,
          "description": "Delivery method type (BANK, CASH, WALLET, DEBIT)."
        },
        {
          "name": "bank_name",
          "type": "string",
          "required": false,
          "description": "Bank name."
        },
        {
          "name": "clabe",
          "type": "string",
          "required": false,
          "description": "CLABE (18 digits)."
        },
        {
          "name": "account_number",
          "type": "string",
          "required": false,
          "description": "Account number."
        },
        {
          "name": "account_type",
          "type": "string",
          "required": false,
          "description": "Account type."
        },
        {
          "name": "wallet_type",
          "type": "string",
          "required": false,
          "description": "Wallet type."
        },
        {
          "name": "phone_number",
          "type": "string",
          "required": false,
          "description": "Phone number."
        },
        {
          "name": "card_number",
          "type": "string",
          "required": false,
          "description": "Card number."
        },
        {
          "name": "city",
          "type": "string",
          "required": false,
          "description": "City."
        },
        {
          "name": "state",
          "type": "string",
          "required": false,
          "description": "State."
        }
      ],
      "requires_confirmation": true,
      "confirmation_template": "Save {first_name} {last_name} as a recipient?\n\nCountry: {country}\nDelivery: {delivery_type}",
      "side_effects": "write"
    },
    {
      "name": "save_delivery_method",
      "description": "Adds a new delivery method to an existing recipient.",
      "parameters": [
        {
          "name": "recipient_id",
          "type": "string",
          "required": true,
          "description": "Recipient ID."
        },
        {
          "name": "delivery_type",
          "type": "string",
          "required": true,
          "description": "Delivery type."
        },
        {
          "name": "bank_name",
          "type": "string",
          "required": false,
          "description": "Bank name."
        },
        {
          "name": "clabe",
          "type": "string",
          "required": false,
          "description": "CLABE."
        },
        {
          "name": "account_number",
          "type": "string",
          "required": false,
          "description": "Account number."
        },
        {
          "name": "account_type",
          "type": "string",
          "required": false,
          "description": "Account type."
        },
        {
          "name": "wallet_type",
          "type": "string",
          "required": false,
          "description": "Wallet type."
        },
        {
          "name": "phone_number",
          "type": "string",
          "required": false,
          "description": "Phone number."
        },
        {
          "name": "card_number",
          "type": "string",
          "required": false,
          "description": "Card number."
        },
        {
          "name": "city",
          "type": "string",
          "required": false,
          "description": "City."
        },
        {
          "name": "state",
          "type": "string",
          "required": false,
          "description": "State."
        }
      ],
      "requires_confirmation": true,
      "confirmation_template": "Add {delivery_type} as a delivery method?",
      "side_effects": "write"
    },
    {
      "name": "escalate_to_human",
      "description": "Route the conversation to a human agent.",
      "parameters": [
        {
          "name": "reason",
          "type": "string",
          "required": false,
          "description": "Reason."
        }
      ],
      "side_effects": "navigation",
      "requires_confirmation": false
    },
    {
      "name": "go_home",
      "description": "Return to the main Felix agent.",
      "parameters": [],
      "side_effects": "navigation",
      "requires_confirmation": false
    }
  ],
  "subflows": [
    {
      "id": "send_money_flow",
      "name": "Send Money",
      "trigger_description": "When the user wants to send a remittance",
      "initial_state": "select_recipient",
      "data_schema": {
        "recipient_id": {
          "type": "string",
          "description": "Selected recipient ID"
        },
        "recipient_name": {
          "type": "string",
          "description": "Recipient display name"
        },
        "amount_usd": {
          "type": "number",
          "description": "Amount in USD"
        },
        "delivery_method_id": {
          "type": "string",
          "description": "Delivery method ID"
        },
        "country": {
          "type": "string",
          "description": "Destination country"
        }
      },
      "states": [
        {
          "id": "select_recipient",
          "name": "Select Recipient",
          "agent_instructions": "STEP 1: Call list_recipients immediately to show the user their saved recipients.\nSTEP 2: Present the recipients as a numbered list (name, country, delivery method).\nSTEP 3: When the user selects a recipient (by name or number), call get_recipient with the recipient_id to confirm details.\nSTEP 4: After confirming, tell the user you have selected that recipient and ask how much they want to send.",
          "state_tools": [
            "list_recipients",
            "get_recipient"
          ],
          "transitions": [
            {
              "trigger": "recipient_selected",
              "target": "collect_amount",
              "condition": "recipient_id is not None"
            },
            {
              "trigger": "wants_new_recipient",
              "target": "exit"
            }
          ],
          "on_enter": null,
          "is_final": false
        },
        {
          "id": "collect_amount",
          "name": "Collect Amount",
          "agent_instructions": "The user needs to provide the amount in USD.\nSTEP 1: If the user already mentioned an amount, use it. Otherwise ask how much they want to send.\nSTEP 2: Once you have the amount, call create_quote with the amount_usd and recipient's country to get the full breakdown (fees, exchange rate, amount received).\nSTEP 3: Present the quote clearly: amount sending, fee, exchange rate, amount recipient will receive.\nSTEP 4: Ask the user to confirm the amount or change it.",
          "state_tools": [
            "get_exchange_rate",
            "create_quote",
            "get_user_limits"
          ],
          "transitions": [
            {
              "trigger": "valid_amount",
              "target": "select_delivery_method",
              "condition": "amount_usd > 0"
            }
          ],
          "on_enter": {
            "message": "How much would you like to send to {recipient_name}?"
          },
          "is_final": false
        },
        {
          "id": "select_delivery_method",
          "name": "Select Delivery Method",
          "agent_instructions": "STEP 1: Call get_recipient with the recipient_id from collected data to check their saved delivery methods.\nSTEP 2: If the recipient has only ONE delivery method, suggest using it and ask for confirmation.\nSTEP 3: If the recipient has MULTIPLE methods, list them and ask the user to choose.\nSTEP 4: Once a method is selected, if it's CASH, tell the user you need a pickup location next. Otherwise, proceed to the transfer summary.",
          "state_tools": [
            "get_recipient",
            "get_delivery_methods"
          ],
          "transitions": [
            {
              "trigger": "method_selected_not_cash",
              "target": "review_summary"
            },
            {
              "trigger": "cash_selected",
              "target": "collect_location"
            }
          ],
          "on_enter": {
            "message": "How should {recipient_name} receive the money?"
          },
          "is_final": false
        },
        {
          "id": "collect_location",
          "name": "Collect Location",
          "agent_instructions": "For cash pickup, ask for the city and state where the recipient will pick up.",
          "state_tools": [],
          "transitions": [
            {
              "trigger": "location_provided",
              "target": "review_summary"
            }
          ],
          "on_enter": {
            "message": "What city should {recipient_name} pick up the cash in?"
          },
          "is_final": false
        },
        {
          "id": "review_summary",
          "name": "Review Summary",
          "agent_instructions": "STEP 1: Call create_quote with the amount_usd and recipient's country to get fresh numbers.\nSTEP 2: Present a clear summary: recipient name, amount in USD, fee, exchange rate, amount they will receive in local currency, delivery method.\nSTEP 3: Ask the user to confirm the transfer, modify the amount, or cancel.\nIMPORTANT: Do NOT call create_transfer yet. Wait for explicit user confirmation first.",
          "state_tools": [
            "create_quote"
          ],
          "transitions": [
            {
              "trigger": "user_confirms",
              "target": "generate_payment"
            },
            {
              "trigger": "user_wants_modification",
              "target": "collect_amount"
            },
            {
              "trigger": "user_cancels",
              "target": "error_state"
            }
          ],
          "on_enter": {
            "message": "Here's your transfer summary. Please review and confirm."
          },
          "is_final": false
        },
        {
          "id": "generate_payment",
          "name": "Generate Payment",
          "agent_instructions": "STEP 1: Call create_transfer with the collected recipient_id, amount_usd, and delivery_method_id from the collected data.\nSTEP 2: The system will ask the user for final confirmation (requires_confirmation is on). Wait for the confirmation flow to complete.\nDo NOT ask the user to confirm again - the tool handles confirmation automatically.",
          "state_tools": [
            "create_transfer"
          ],
          "transitions": [
            {
              "trigger": "transfer_success",
              "target": "completed"
            },
            {
              "trigger": "transfer_error",
              "target": "error_state"
            }
          ],
          "on_enter": null,
          "is_final": false
        },
        {
          "id": "completed",
          "name": "Completed",
          "agent_instructions": "The transfer was successful! Tell the user it's being processed and ask if they need anything else. If they say no or are done, call go_home.",
          "state_tools": [
            "go_home"
          ],
          "transitions": [],
          "on_enter": {
            "message": "Your transfer is being processed! Is there anything else I can help you with?"
          },
          "is_final": true
        },
        {
          "id": "error_state",
          "name": "Error",
          "agent_instructions": "Something went wrong with the transfer. Offer the user two options: try again or speak with a support agent. If they want to retry, the flow will restart. If they want support, call escalate_to_human.",
          "state_tools": [
            "escalate_to_human"
          ],
          "transitions": [
            {
              "trigger": "retry",
              "target": "select_recipient"
            }
          ],
          "on_enter": {
            "message": "I'm sorry, there was an issue. Would you like to try again or speak with support?"
          },
          "is_final": false
        }
      ]
    },
    {
      "id": "add_recipient_flow",
      "name": "Add Recipient",
      "trigger_description": "When the user wants to add a new recipient",
      "initial_state": "collect_name",
      "data_schema": {
        "first_name": {
          "type": "string"
        },
        "last_name": {
          "type": "string"
        },
        "country": {
          "type": "string"
        },
        "delivery_type": {
          "type": "string"
        }
      },
      "states": [
        {
          "id": "collect_name",
          "name": "Collect Name",
          "agent_instructions": "Ask for the recipient's first and last name.",
          "state_tools": [],
          "transitions": [
            {
              "trigger": "name_provided",
              "target": "select_country"
            }
          ],
          "on_enter": {
            "message": "Let's add a new recipient. What's their full name?"
          },
          "is_final": false
        },
        {
          "id": "select_country",
          "name": "Select Country",
          "agent_instructions": "Ask which country the recipient lives in. We support: Mexico (MX), Guatemala (GT), Honduras (HN), Colombia (CO), Dominican Republic (DO), El Salvador (SV), Nicaragua (NI).",
          "state_tools": [
            "get_delivery_methods"
          ],
          "transitions": [
            {
              "trigger": "country_selected",
              "target": "select_delivery_type"
            }
          ],
          "on_enter": {
            "message": "What country does {first_name} live in? We support Mexico, Guatemala, Honduras, Colombia, Dominican Republic, El Salvador, and Nicaragua."
          },
          "is_final": false
        },
        {
          "id": "select_delivery_type",
          "name": "Select Delivery Type",
          "agent_instructions": "Use get_delivery_methods for the selected country and show available options.",
          "state_tools": [
            "get_delivery_methods"
          ],
          "transitions": [
            {
              "trigger": "delivery_type_selected",
              "target": "collect_delivery_details"
            }
          ],
          "on_enter": {
            "message": "How will {first_name} receive money?"
          },
          "is_final": false
        },
        {
          "id": "collect_delivery_details",
          "name": "Collect Details",
          "agent_instructions": "Collect the required information based on delivery type:\n- BANK (MX): CLABE or bank + account\n- BANK (CO): Bank, account, type\n- WALLET: wallet type + phone\n- DEBIT: card number\n- CASH: move to collect_location",
          "state_tools": [],
          "transitions": [
            {
              "trigger": "details_collected",
              "target": "confirm_recipient"
            },
            {
              "trigger": "cash_type",
              "target": "collect_location"
            }
          ],
          "on_enter": {
            "message": "I'll need some details for {delivery_type} delivery."
          },
          "is_final": false
        },
        {
          "id": "collect_location",
          "name": "Collect Location",
          "agent_instructions": "For cash pickup, ask for city and state.",
          "state_tools": [],
          "transitions": [
            {
              "trigger": "location_provided",
              "target": "confirm_recipient"
            }
          ],
          "on_enter": {
            "message": "What city and state should {first_name} pick up the cash in?"
          },
          "is_final": false
        },
        {
          "id": "confirm_recipient",
          "name": "Confirm Recipient",
          "agent_instructions": "Show a summary and call save_recipient with all collected data.",
          "state_tools": [
            "save_recipient"
          ],
          "transitions": [
            {
              "trigger": "confirmed",
              "tool_trigger": "save_recipient",
              "target": "completed",
              "condition": "_tool_result.recipient_id is not None"
            },
            {
              "trigger": "wants_modification",
              "target": "collect_name"
            }
          ],
          "on_enter": {
            "message": "Here's the new recipient information. Please confirm to save."
          },
          "is_final": false
        },
        {
          "id": "completed",
          "name": "Completed",
          "agent_instructions": "Recipient saved. Offer to send money now or go home.",
          "state_tools": [
            "start_flow_send_money",
            "go_home"
          ],
          "transitions": [],
          "on_enter": {
            "message": "{first_name} {last_name} has been saved! Would you like to send money to them now?"
          },
          "is_final": true
        }
      ]
    },
    {
      "id": "quick_send_flow",
      "name": "Quick Send",
      "trigger_description": "When the user wants to repeat a recent transfer",
      "initial_state": "show_quick_options",
      "states": [
        {
          "id": "show_quick_options",
          "name": "Show Options",
          "agent_instructions": "Use list_transfers to get recent completed transfers. Present as numbered options.",
          "state_tools": [
            "list_transfers"
          ],
          "transitions": [
            {
              "trigger": "transfer_selected",
              "target": "confirm_quick_send"
            },
            {
              "trigger": "no_transfers",
              "target": "exit"
            }
          ],
          "on_enter": {
            "message": "Which transfer would you like to repeat?"
          },
          "is_final": false
        },
        {
          "id": "confirm_quick_send",
          "name": "Confirm Quick Send",
          "agent_instructions": "Show pre-filled details. Use create_quote for current rate, then create_transfer.",
          "state_tools": [
            "create_quote",
            "create_transfer"
          ],
          "transitions": [
            {
              "trigger": "confirmed",
              "target": "completed"
            },
            {
              "trigger": "wants_modification",
              "target": "exit"
            },
            {
              "trigger": "cancelled",
              "target": "exit"
            }
          ],
          "on_enter": {
            "message": "Send ${amount_usd} USD to {recipient_name} again?"
          },
          "is_final": false
        },
        {
          "id": "completed",
          "name": "Completed",
          "agent_instructions": "Quick send successful. Call go_home.",
          "state_tools": [
            "go_home"
          ],
          "transitions": [],
          "on_enter": {
            "message": "Your transfer is being processed! Is there anything else I can help you with?"
          },
          "is_final": true
        }
      ]
    },
    {
      "id": "snpl_remittance_flow",
      "name": "SNPL Remittance",
      "trigger_description": "When the user wants to send money using their approved SNPL credit",
      "initial_state": "confirm_snpl_amount",
      "data_schema": {
        "snpl_loan_id": {
          "type": "string",
          "description": "SNPL loan ID funding this transfer"
        },
        "amount_usd": {
          "type": "number",
          "description": "Amount in USD (from SNPL)"
        },
        "recipient_id": {
          "type": "string",
          "description": "Selected recipient ID"
        },
        "recipient_name": {
          "type": "string",
          "description": "Recipient display name"
        },
        "delivery_method_id": {
          "type": "string",
          "description": "Delivery method ID"
        },
        "country": {
          "type": "string",
          "description": "Destination country"
        }
      },
      "timeout_config": {
        "durationMinutes": 15,
        "onTimeout": "abandon",
        "reminderMessage": "Your SNPL transfer is still in progress. Would you like to continue?"
      },
      "states": [
        {
          "id": "confirm_snpl_amount",
          "name": "Confirm SNPL Amount",
          "agent_instructions": "The user is sending money using their SNPL credit. Confirm the amount they're sending (passed as flow parameter). The amount is already funded by their SNPL loan, so they don't need to pay now. Ask them to proceed to select a recipient.",
          "state_tools": [],
          "transitions": [
            {
              "trigger": "amount_confirmed",
              "target": "select_recipient"
            }
          ],
          "on_enter": {
            "message": "You're sending ${amount_usd} USD using your SNPL credit (Loan: {snpl_loan_id}).\n\nNo payment needed now - this is funded by your SNPL loan!\n\nLet's select who you want to send it to."
          },
          "is_final": false
        },
        {
          "id": "select_recipient",
          "name": "Select Recipient",
          "agent_instructions": "Call list_recipients as your first action to show saved recipients. Show all saved recipients as numbered options and tell the user they can select one or add a new recipient if needed. If user wants to add a new recipient, they need to exit this flow and add a recipient first, then return.",
          "state_tools": [
            "list_recipients",
            "get_recipient"
          ],
          "transitions": [
            {
              "trigger": "recipient_selected",
              "target": "select_delivery_method",
              "condition": "recipient_id is not None"
            },
            {
              "trigger": "wants_new_recipient",
              "target": "exit_to_add_recipient"
            }
          ],
          "on_enter": null,
          "is_final": false
        },
        {
          "id": "select_delivery_method",
          "name": "Select Delivery Method",
          "agent_instructions": "Show the recipient's saved delivery methods using get_recipient. If they only have one, confirm using it. If cash is selected, move to collect_location.",
          "state_tools": [
            "get_recipient",
            "get_delivery_methods"
          ],
          "transitions": [
            {
              "trigger": "method_selected_not_cash",
              "target": "review_summary"
            },
            {
              "trigger": "cash_selected",
              "target": "collect_location"
            }
          ],
          "on_enter": {
            "message": "How should {recipient_name} receive the money?"
          },
          "is_final": false
        },
        {
          "id": "collect_location",
          "name": "Collect Location",
          "agent_instructions": "For cash pickup, ask for the city and state where the recipient will pick up.",
          "state_tools": [],
          "transitions": [
            {
              "trigger": "location_provided",
              "target": "review_summary"
            }
          ],
          "on_enter": {
            "message": "What city should {recipient_name} pick up the cash in?"
          },
          "is_final": false
        },
        {
          "id": "review_summary",
          "name": "Review Summary",
          "agent_instructions": "Display the complete transfer summary: amount (funded by SNPL), recipient, delivery method, exchange rate. Use get_exchange_rate to show what they'll receive. Note that there are no fees - the SNPL loan covers everything. Ask user to confirm.",
          "state_tools": [
            "get_exchange_rate"
          ],
          "transitions": [
            {
              "trigger": "user_confirms",
              "target": "process_transfer"
            },
            {
              "trigger": "user_wants_modification",
              "target": "select_recipient"
            },
            {
              "trigger": "user_cancels",
              "target": "cancelled"
            }
          ],
          "on_enter": {
            "message": "Here's your SNPL transfer summary. Please review and confirm."
          },
          "is_final": false
        },
        {
          "id": "process_transfer",
          "name": "Process Transfer",
          "agent_instructions": "Call create_snpl_transfer with the snpl_loan_id, recipient_id, amount_usd, and delivery_method_id. The tool requires confirmation.",
          "state_tools": [
            "create_snpl_transfer"
          ],
          "transitions": [
            {
              "trigger": "transfer_success",
              "target": "completed"
            },
            {
              "trigger": "transfer_error",
              "target": "error_state"
            }
          ],
          "on_enter": null,
          "is_final": false
        },
        {
          "id": "completed",
          "name": "Completed",
          "agent_instructions": "SNPL transfer was successful! Remind user about their loan payment schedule. Use go_home to return to main agent.",
          "state_tools": [
            "go_home"
          ],
          "transitions": [],
          "on_enter": {
            "message": "Your SNPL transfer is being processed!\n\nRemember: Your first loan payment is due on your scheduled date. You can check your payment schedule anytime."
          },
          "is_final": true
        },
        {
          "id": "error_state",
          "name": "Error",
          "agent_instructions": "Something went wrong with the transfer. Offer to retry or escalate.",
          "state_tools": [
            "escalate_to_human",
            "go_home"
          ],
          "transitions": [
            {
              "trigger": "retry",
              "target": "select_recipient"
            }
          ],
          "on_enter": {
            "message": "I'm sorry, there was an issue processing your transfer. Would you like to try again or speak with support?"
          },
          "is_final": false
        },
        {
          "id": "exit_to_add_recipient",
          "name": "Exit to Add Recipient",
          "agent_instructions": "User wants to add a new recipient. Let them know they need to add the recipient first, then come back to use their SNPL credit. Exit the flow.",
          "state_tools": [
            "start_flow_add_recipient"
          ],
          "transitions": [],
          "on_enter": {
            "message": "Let's add your new recipient first. After that, you can send them money using your SNPL credit."
          },
          "is_final": true
        },
        {
          "id": "cancelled",
          "name": "Cancelled",
          "agent_instructions": "User cancelled the SNPL transfer. Let them know their SNPL credit is still available for future use.",
          "state_tools": [
            "go_home"
          ],
          "transitions": [],
          "on_enter": {
            "message": "No problem! Your SNPL credit is still available whenever you're ready to send money."
          },
          "is_final": true
        }
      ]
    }
  ],
  "response_templates": [
    {
      "name": "Limit Exceeded",
      "trigger_config": {
        "type": "tool_error",
        "toolName": "create_transfer",
        "errorCode": "LIMIT_EXCEEDED"
      },
      "template": "This transfer exceeds your {limit_type} limit.\n\nAvailable: ${available} USD\nRequested: ${requested} USD\n\nWould you like to verify your identity to increase your limits?",
      "required_fields": [
        "limit_type",
        "available",
        "requested"
      ],
      "enforcement": "mandatory"
    }
  ],
  "test_scenarios": [
    {
      "id": "remittance_happy_path",
      "name": "Happy Path - Send Money to Existing Recipient",
      "description": "Test the send money flow: user wants to send money, selects a recipient, provides amount, gets a quote",
      "initial_context": {
        "user_id": "user_demo",
        "language": "es"
      },
      "turns": [
        {
          "user_input": "Quiero enviar dinero a México",
          "expected_behaviors": [
            {"type": "tool_call", "tool_name": "start_flow_send_money"},
            {"type": "tool_call", "tool_name": "list_recipients"}
          ]
        },
        {
          "user_input": "A María García",
          "expected_behaviors": [
            {"type": "contains_any", "text": ["María", "cuánto", "amount", "monto"]}
          ]
        },
        {
          "user_input": "200 dólares",
          "expected_behaviors": [
            {"type": "tool_call", "tool_name": "create_quote"},
            {"type": "contains_any", "text": ["200", "USD", "MXN", "tasa", "rate", "comisión", "fee"]}
          ]
        }
      ],
      "success_criteria": {
        "no_escalation": true,
        "no_error_state": true
      },
      "tags": ["smoke", "happy-path"],
      "enabled": true
    },
    {
      "id": "remittance_exchange_rate",
      "name": "Exchange Rate Check",
      "description": "User asks about exchange rate without initiating a transfer",
      "initial_context": {
        "user_id": "user_demo",
        "language": "es"
      },
      "turns": [
        {
          "user_input": "¿Cuál es el tipo de cambio a México?",
          "expected_behaviors": [
            {"type": "tool_call", "tool_name": "get_exchange_rate"},
            {"type": "contains_any", "text": ["tasa", "cambio", "MXN", "peso"]}
          ]
        }
      ],
      "success_criteria": {
        "no_escalation": true,
        "no_error_state": true
      },
      "tags": ["smoke", "info-query"],
      "enabled": true
    },
    {
      "id": "remittance_transfer_history",
      "name": "Transfer History Check",
      "description": "User asks about recent transfers",
      "initial_context": {
        "user_id": "user_demo",
        "language": "es"
      },
      "turns": [
        {
          "user_input": "¿Cuáles son mis transferencias recientes?",
          "expected_behaviors": [
            {"type": "tool_call", "tool_name": "list_transfers"},
            {"type": "contains_any", "text": ["transferencia", "envío", "reciente"]}
          ]
        }
      ],
      "success_criteria": {
        "no_escalation": true,
        "no_error_state": true
      },
      "tags": ["smoke", "info-query"],
      "enabled": true
    }
  ]
}
