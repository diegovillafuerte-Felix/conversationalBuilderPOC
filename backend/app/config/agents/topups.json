{
  "id": "topups",
  "name": "Top-Ups Agent",
  "description": "I'm the Felix top-ups specialist. I can help you with:\n- Sending top-ups to phones in Mexico and Latin America\n- Viewing available carriers (Telcel, Movistar, AT&T, etc.)\n- Checking your frequent numbers\n- Viewing top-up history\n\nTop-ups arrive instantly to the phone.",
  "system_prompt_addition": "CRITICAL DELEGATION RULES:\n- When user wants to send a top-up, call start_flow_recarga IMMEDIATELY\n- Do NOT respond with text about top-ups - ONLY call the tool\n- Do NOT ask questions or show information - the flow handles that\n- Your ONLY job is to detect intent and delegate via tool call\n- If user mentions: recarga, top-up, recharge, saldo, airtime -> call start_flow_recarga\n\nThe ONLY valid responses from you are:\n1. Tool call to start_flow_recarga (for top-up intent)\n2. Tool call to go_home (for out-of-scope requests)\n3. Tool call to escalate_to_human (for problems)\n\nERROR HANDLING:\nIf a tool returns an error (e.g., service unavailable, connection error), you MUST respond with a helpful message to the user explaining there was a temporary issue and asking them to try again. Do NOT leave the response empty.",
  "model_config": {
    "model": "gpt-5.2",
    "temperature": 0.5,
    "maxTokens": 1024
  },
  "navigation": {
    "canGoUp": true,
    "canGoHome": true,
    "canEscalate": true
  },
  "parent_agent": "felix",
  "tools": [
    {
      "name": "start_flow_recarga",
      "description": "Use when the user wants to make a top-up. This flow guides the user step by step. Do NOT ask for information before - start the flow and it will take care of it.",
      "parameters": [
        {
          "name": "phone_number",
          "type": "string",
          "required": false,
          "description": "Phone number if the user already provided it"
        }
      ],
      "side_effects": "none",
      "requires_confirmation": false
    },
    {
      "name": "get_carriers",
      "description": "Gets the available carriers for a country.",
      "parameters": [
        {
          "name": "country",
          "type": "string",
          "required": false,
          "description": "Country code (MX, GT, etc.). Default MX."
        }
      ],
      "side_effects": "read",
      "requires_confirmation": false
    },
    {
      "name": "get_frequent_numbers",
      "description": "Gets the numbers the user frequently tops up.",
      "parameters": [],
      "side_effects": "read",
      "requires_confirmation": false
    },
    {
      "name": "detect_carrier",
      "description": "Detects the carrier of a phone number.",
      "parameters": [
        {
          "name": "phone_number",
          "type": "string",
          "required": true,
          "description": "Phone number with country code"
        }
      ],
      "side_effects": "read",
      "requires_confirmation": false
    },
    {
      "name": "get_topup_price",
      "description": "Gets the USD price of a top-up.",
      "parameters": [
        {
          "name": "carrier_id",
          "type": "string",
          "required": true,
          "description": "Carrier ID"
        },
        {
          "name": "amount",
          "type": "number",
          "required": true,
          "description": "Top-up amount in local currency"
        },
        {
          "name": "country",
          "type": "string",
          "required": false,
          "description": "Country code"
        }
      ],
      "side_effects": "read",
      "requires_confirmation": false
    },
    {
      "name": "send_topup",
      "description": "Sends a top-up to a phone number. Only use this tool when you have the number, carrier, and amount confirmed.",
      "parameters": [
        {
          "name": "phone_number",
          "type": "string",
          "required": true,
          "description": "Destination phone number"
        },
        {
          "name": "carrier_id",
          "type": "string",
          "required": true,
          "description": "Carrier ID"
        },
        {
          "name": "amount",
          "type": "number",
          "required": true,
          "description": "Top-up amount in local currency"
        }
      ],
      "requires_confirmation": true,
      "confirmation_template": "Confirm sending a top-up of ${amount} MXN to {phone_number}?\n\nCarrier: {carrier_id}\nWill be charged to your payment method\nArrival: Instant",
      "side_effects": "financial",
      "flow_transition": {
        "onSuccess": "completed",
        "onError": "error_state"
      }
    }
  ],
  "subflows": [
    {
      "id": "recarga",
      "name": "Top-Up Flow",
      "trigger_description": "When the user wants to send a mobile top-up",
      "initial_state": "collect_number",
      "data_schema": {
        "phone_number": {"type": "string", "description": "Destination phone number"},
        "carrier_id": {"type": "string", "description": "Detected carrier ID"},
        "carrier_name": {"type": "string", "description": "Carrier name"},
        "amount": {"type": "number", "description": "Top-up amount in MXN"},
        "usd_total": {"type": "number", "description": "Total in USD"}
      },
      "timeout_config": {
        "durationMinutes": 10,
        "onTimeout": "abandon",
        "reminderMessage": "Are you still there? Your top-up is pending."
      },
      "states": [
        {
          "id": "collect_number",
          "name": "Collect Number",
          "agent_instructions": "You are collecting the phone number for a top-up.\n\nYour first action should be to call get_frequent_numbers to show the user their saved numbers. Then ask which number they want to top up, or let them provide a new number.\n\nWhen they provide a number (from the list or new), use detect_carrier to identify the carrier.",
          "state_tools": ["get_frequent_numbers", "detect_carrier"],
          "transitions": [
            {
              "trigger": "carrier_detected",
              "tool_trigger": "detect_carrier",
              "target": "select_amount",
              "condition": "_tool_result.carrier is not None"
            }
          ],
          "on_enter": {
            "message": "What phone number would you like to top up?"
          },
          "is_final": false
        },
        {
          "id": "select_amount",
          "name": "Select Amount",
          "agent_instructions": "You are in the step of selecting the top-up amount.\n\nThe carrier has been detected. Your task:\n1. Show the available top-up options for the carrier (Telcel: $50, $100, $200, $500 MXN)\n2. Use get_topup_price to show the USD cost when the user asks\n3. Wait for the user to select an amount\n\nWhen the user selects an amount, use send_topup to process the top-up.",
          "state_tools": ["get_topup_price", "send_topup"],
          "transitions": [
            {
              "trigger": "amount_selected",
              "target": "confirm_payment",
              "condition": "amount > 0"
            }
          ],
          "on_enter": {
            "message": "The number is from {carrier_name}. These are the available top-up options:\n\n$50 MXN\n$100 MXN\n$200 MXN\n$500 MXN\n\nHow much do you want to top up?"
          },
          "is_final": false
        },
        {
          "id": "confirm_payment",
          "name": "Confirm Payment",
          "agent_instructions": "You are in the payment confirmation step.\n\nYour task:\n1. Show a summary of the top-up (number, carrier, amount, USD cost)\n2. Simulate a payment link: \"Your payment link is ready\"\n3. Use send_topup to execute the top-up - this will ask for confirmation automatically\n\nWhen the user confirms, the top-up will be processed.",
          "state_tools": ["send_topup"],
          "transitions": [
            {
              "trigger": "payment_confirmed",
              "target": "completed",
              "condition": "topup_success == True"
            },
            {
              "trigger": "payment_failed",
              "target": "error_state",
              "condition": "topup_success == False"
            }
          ],
          "on_enter": {
            "message": "Top-up summary:\n\nNumber: {phone_number}\nCarrier: {carrier_name}\nAmount: ${amount} MXN\n\nYour payment link is ready. Confirm the top-up?"
          },
          "is_final": false
        },
        {
          "id": "completed",
          "name": "Top-Up Completed",
          "agent_instructions": "The top-up was completed successfully. You can use go_home if the user wants to do something else, or provide a natural farewell.",
          "state_tools": [],
          "transitions": [],
          "on_enter": null,
          "is_final": true
        },
        {
          "id": "error_state",
          "name": "Top-Up Error",
          "agent_instructions": "There was an error in the top-up.\n\nYour task:\n1. Inform the user of the error\n2. Offer to try again or contact support\n3. Use go_home if the user wants to cancel",
          "state_tools": [],
          "transitions": [
            {
              "trigger": "retry",
              "target": "collect_number"
            }
          ],
          "on_enter": {
            "message": "Sorry, there was a problem processing the top-up. Do you want to try again or would you prefer to talk to an agent?"
          },
          "is_final": false
        }
      ]
    }
  ],
  "response_templates": [
    {
      "name": "Top-Up Error",
      "trigger_config": {
        "type": "tool_error",
        "toolName": "send_topup"
      },
      "template": "We couldn't process the top-up: {error}\n\nDo you want to try again?",
      "required_fields": ["error"],
      "enforcement": "mandatory"
    }
  ],
  "test_scenarios": [
    {
      "id": "topup_happy_path",
      "name": "Happy Path - Complete Top-Up",
      "description": "Test a successful topup flow from start to finish",
      "initial_context": {
        "user_id": "test_topup_user",
        "user_balance": 50.0,
        "language": "es"
      },
      "turns": [
        {
          "user_input": "Quiero hacer una recarga",
          "expected_behaviors": [
            {"type": "contains_any", "text": ["recarga", "número", "teléfono"]}
          ]
        },
        {
          "user_input": "+52 55 1234 5678",
          "expected_behaviors": [
            {"type": "contains_any", "text": ["Telcel", "operador", "carrier"]}
          ]
        }
      ],
      "success_criteria": {
        "no_escalation": true,
        "no_error_state": true
      },
      "tags": ["smoke", "happy-path"],
      "enabled": true
    },
    {
      "id": "topup_invalid_number_recovery",
      "name": "Invalid Phone Number Recovery",
      "description": "Test that agent handles invalid phone numbers gracefully and allows retry",
      "initial_context": {
        "user_id": "test_invalid_user",
        "user_balance": 100.0,
        "language": "es"
      },
      "turns": [
        {
          "user_input": "Recarga al 555-1234",
          "expected_behaviors": [
            {"type": "contains_any", "text": ["inválido", "no reconozco", "válido", "número"]}
          ]
        },
        {
          "user_input": "+52 55 9876 5432",
          "expected_behaviors": [
            {"type": "contains_any", "text": ["Telcel", "operador", "detectado"]}
          ]
        }
      ],
      "success_criteria": {
        "no_escalation": true
      },
      "tags": ["error-handling", "recovery"],
      "enabled": true
    },
    {
      "id": "topup_frequent_numbers",
      "name": "View Frequent Numbers",
      "description": "Test that user can view their frequent numbers",
      "initial_context": {
        "user_id": "user_demo",
        "user_balance": 50.0,
        "language": "es"
      },
      "turns": [
        {
          "user_input": "Quiero ver mis números frecuentes",
          "expected_behaviors": [
            {"type": "contains_any", "text": ["frecuentes", "números", "Mamá", "Hermano"]}
          ]
        }
      ],
      "success_criteria": {
        "no_escalation": true
      },
      "tags": ["feature"],
      "enabled": true
    }
  ]
}
