{
  "id": "snpl",
  "name": "Send Now Pay Later",
  "description": "I'm the SNPL specialist. I can help you with:\n- Checking if you qualify for credit\n- Applying for $200-$1000 to send remittances\n- Making payments on your loans\n- Viewing your loan status and payment schedule\n\nWith SNPL, you can send money to your loved ones now and pay over 4-26 weeks.",
  "system_prompt_addition": "IMPORTANT - FLOW TRIGGERS:\n- When user wants to APPLY for SNPL or get credit: use 'start_flow_apply_snpl'\n- When user wants to MAKE A PAYMENT on their loan: use 'start_flow_pay_snpl'\n- When user wants to USE their approved credit to send money: use 'start_flow_use_snpl'\n\nDo NOT manually collect amounts, terms, or other details - the flows handle all data collection.\n\nFor informational queries (eligibility check, loan status, payment history), use the appropriate info tools directly.",
  "default_tools": [
    "start_flow_apply_snpl",
    "start_flow_pay_snpl",
    "start_flow_use_snpl",
    "get_snpl_eligibility",
    "get_snpl_overview",
    "list_loans"
  ],
  "model_config": {
    "model": "gpt-5.2",
    "temperature": 0.5,
    "maxTokens": 1024
  },
  "navigation": {
    "canGoUp": true,
    "canGoHome": true,
    "canEscalate": true
  },
  "parent_agent": "felix",
  "tools": [
    {
      "name": "start_flow_apply_snpl",
      "description": "Start the SNPL application flow. Use when user wants to apply for credit, get a loan, or mentions 'envía ahora paga después'. Do NOT ask questions first - the flow handles everything.",
      "parameters": [],
      "side_effects": "flow",
      "requires_confirmation": false,
      "starts_flow": "apply_snpl_flow"
    },
    {
      "name": "start_flow_pay_snpl",
      "description": "Start the payment flow. Use when user wants to make a payment on their SNPL loan.",
      "parameters": [],
      "side_effects": "flow",
      "requires_confirmation": false,
      "starts_flow": "pay_snpl_flow"
    },
    {
      "name": "start_flow_use_snpl",
      "description": "Route user to remittances to use their SNPL credit. Use when user has approved credit and wants to send money now.",
      "parameters": [
        {
          "name": "loan_id",
          "type": "string",
          "required": true,
          "description": "The SNPL loan ID to use for the remittance"
        },
        {
          "name": "amount_usd",
          "type": "number",
          "required": true,
          "description": "The amount to send (from SNPL loan)"
        }
      ],
      "side_effects": "navigation",
      "requires_confirmation": false,
      "routing": {
        "type": "start_flow",
        "target": "snpl_remittance_flow",
        "cross_agent": "remittances"
      }
    },
    {
      "name": "get_snpl_eligibility",
      "description": "Check if the user is eligible for SNPL and their pre-approved amount. Use when user asks about eligibility, limits, or if they qualify.",
      "parameters": [],
      "side_effects": "read",
      "requires_confirmation": false
    },
    {
      "name": "get_snpl_overview",
      "description": "Get overview of user's SNPL status including active loans, total balance, and next payment. Use when user asks about their loans, balance, or 'how much do I owe'.",
      "parameters": [],
      "side_effects": "read",
      "requires_confirmation": false
    },
    {
      "name": "get_loan_details",
      "description": "Get detailed information about a specific loan including balance, payment schedule, and associated remittance.",
      "parameters": [
        {
          "name": "loan_id",
          "type": "string",
          "required": true,
          "description": "The SNPL loan ID"
        }
      ],
      "side_effects": "read",
      "requires_confirmation": false
    },
    {
      "name": "list_loans",
      "description": "List all user's SNPL loans. Can filter by status (ACTIVE, PAID_OFF, etc).",
      "parameters": [
        {
          "name": "status",
          "type": "string",
          "required": false,
          "description": "Filter by loan status: ACTIVE, PAID_OFF, PAST_DUE, DEFAULTED"
        }
      ],
      "side_effects": "read",
      "requires_confirmation": false
    },
    {
      "name": "get_payment_schedule",
      "description": "Get the payment schedule for a specific loan showing all upcoming payments.",
      "parameters": [
        {
          "name": "loan_id",
          "type": "string",
          "required": true,
          "description": "The SNPL loan ID"
        }
      ],
      "side_effects": "read",
      "requires_confirmation": false
    },
    {
      "name": "get_payment_history",
      "description": "Get history of payments made on SNPL loans.",
      "parameters": [
        {
          "name": "loan_id",
          "type": "string",
          "required": false,
          "description": "Specific loan ID (optional - omit for all loans)"
        },
        {
          "name": "limit",
          "type": "number",
          "required": false,
          "description": "Maximum number of payments to return (default 10)"
        }
      ],
      "side_effects": "read",
      "requires_confirmation": false
    },
    {
      "name": "calculate_terms",
      "description": "Calculate loan terms (weekly payment, total cost, APR) for a given amount and term length.",
      "parameters": [
        {
          "name": "amount",
          "type": "number",
          "required": true,
          "description": "Loan amount in USD (200-1000)"
        },
        {
          "name": "weeks",
          "type": "number",
          "required": true,
          "description": "Term length in weeks (4, 8, 12, 16, 20, or 26)"
        }
      ],
      "side_effects": "read",
      "requires_confirmation": false
    },
    {
      "name": "submit_snpl_application",
      "description": "Submit an SNPL loan application. Used within the apply_snpl_flow to finalize the application.",
      "parameters": [
        {
          "name": "amount",
          "type": "number",
          "required": true,
          "description": "Requested loan amount in USD"
        },
        {
          "name": "term_weeks",
          "type": "number",
          "required": true,
          "description": "Loan term in weeks"
        }
      ],
      "requires_confirmation": true,
      "confirmation_template": "Confirm your SNPL application:\n• Amount: ${amount}\n• Term: ${term_weeks} weeks\n\nDo you want to proceed?",
      "side_effects": "financial",
      "flow_transition": {
        "onSuccess": "completed",
        "onError": "rejected"
      }
    },
    {
      "name": "make_snpl_payment",
      "description": "Make a payment on an SNPL loan. Used within the pay_snpl_flow.",
      "parameters": [
        {
          "name": "loan_id",
          "type": "string",
          "required": true,
          "description": "The SNPL loan ID to pay"
        },
        {
          "name": "amount",
          "type": "number",
          "required": true,
          "description": "Amount to pay in USD"
        },
        {
          "name": "payment_method_id",
          "type": "string",
          "required": false,
          "description": "Payment method ID (optional)"
        }
      ],
      "requires_confirmation": true,
      "confirmation_template": "Confirm payment of ${amount} to loan ${loan_id}?",
      "side_effects": "financial",
      "flow_transition": {
        "onSuccess": "completed",
        "onError": "error_state"
      }
    },
    {
      "name": "go_home",
      "description": "Return to the main Felix assistant.",
      "parameters": [],
      "side_effects": "navigation",
      "requires_confirmation": false
    },
    {
      "name": "escalate_to_human",
      "description": "Transfer to a human agent for complex issues.",
      "parameters": [
        {
          "name": "reason",
          "type": "string",
          "required": false,
          "description": "Reason for escalation"
        }
      ],
      "side_effects": "navigation",
      "requires_confirmation": false
    }
  ],
  "subflows": [
    {
      "id": "apply_snpl_flow",
      "name": "SNPL Application",
      "trigger_description": "Triggered when user wants to apply for SNPL credit",
      "initial_state": "check_eligibility",
      "data_schema": {
        "eligibility_tier": {
          "type": "string",
          "description": "User's eligibility tier"
        },
        "max_amount": {
          "type": "number",
          "description": "Maximum approved amount"
        },
        "requested_amount": {
          "type": "number",
          "description": "Amount user wants to borrow"
        },
        "term_weeks": {
          "type": "number",
          "description": "Selected term in weeks"
        },
        "apr": {
          "type": "number",
          "description": "Annual percentage rate"
        },
        "weekly_payment": {
          "type": "number",
          "description": "Calculated weekly payment"
        },
        "total_repayment": {
          "type": "number",
          "description": "Total amount to repay"
        },
        "loan_id": {
          "type": "string",
          "description": "Created loan ID"
        }
      },
      "timeout_config": {
        "durationMinutes": 15,
        "onTimeout": "abandon",
        "reminderMessage": "Your SNPL application is still in progress. Would you like to continue?"
      },
      "states": [
        {
          "id": "check_eligibility",
          "name": "Check Eligibility",
          "agent_instructions": "Call get_snpl_eligibility to check the user's eligibility. If eligible, tell them their pre-approved amount and ask how much they'd like to borrow ($200-$1000). If not eligible, explain why and offer to help with something else.",
          "state_tools": [
            "get_snpl_eligibility"
          ],
          "transitions": [
            {
              "trigger": "eligible",
              "tool_trigger": "get_snpl_eligibility",
              "target": "select_amount",
              "condition": "_tool_result.eligible"
            },
            {
              "trigger": "not_eligible",
              "tool_trigger": "get_snpl_eligibility",
              "target": "rejected"
            }
          ],
          "on_enter": {
            "message": "Let me check your SNPL eligibility..."
          }
        },
        {
          "id": "select_amount",
          "name": "Select Amount",
          "agent_instructions": "The user is eligible! Ask them how much they'd like to borrow. They can borrow between $200 and their pre-approved maximum (stored in flow data). Validate that the amount is within range before proceeding.",
          "state_tools": [],
          "transitions": [
            {
              "trigger": "amount_selected",
              "target": "select_term",
              "condition": "amount >= 200 and amount <= max_amount"
            }
          ]
        },
        {
          "id": "select_term",
          "name": "Select Term",
          "agent_instructions": "Ask the user to select their payment term. Available options are: 4, 8, 12, 16, 20, or 26 weeks. Use calculate_terms to show them what the weekly payment would be for different terms. Help them understand that shorter terms mean higher weekly payments but less total interest.",
          "state_tools": [
            "calculate_terms"
          ],
          "transitions": [
            {
              "trigger": "term_selected",
              "target": "review_terms"
            }
          ]
        },
        {
          "id": "review_terms",
          "name": "Review Terms",
          "agent_instructions": "Show a complete summary of the loan terms: amount, term (weeks), APR, weekly payment, total repayment, first payment date. Ask the user to confirm they want to proceed. If they want to change anything, go back to select_amount.",
          "state_tools": [
            "calculate_terms"
          ],
          "transitions": [
            {
              "trigger": "user_confirms",
              "target": "processing"
            },
            {
              "trigger": "user_modifies",
              "target": "select_amount"
            },
            {
              "trigger": "user_cancels",
              "target": "cancelled"
            }
          ]
        },
        {
          "id": "processing",
          "name": "Processing Application",
          "agent_instructions": "Call submit_snpl_application with the selected amount and term_weeks. This will process the application and return the result. The tool has a confirmation step built in.",
          "state_tools": [
            "submit_snpl_application"
          ],
          "transitions": [
            {
              "trigger": "approved",
              "target": "completed",
              "condition": "application.approved == true"
            },
            {
              "trigger": "denied",
              "target": "rejected"
            }
          ],
          "on_enter": {
            "message": "Processing your application..."
          }
        },
        {
          "id": "completed",
          "name": "Application Approved",
          "agent_instructions": "Congratulate the user! Their SNPL application has been approved. Show them their loan details (loan_id, amount, weekly_payment, first_payment_date). Then ask if they would like to send a remittance now using their new credit. If yes, use start_flow_use_snpl to route them to the remittances agent.",
          "state_tools": [
            "start_flow_use_snpl",
            "go_home"
          ],
          "transitions": [],
          "is_final": true
        },
        {
          "id": "rejected",
          "name": "Application Rejected",
          "agent_instructions": "The application was not approved. Explain the reason sympathetically and offer alternatives. Suggest they can try again later or contact support for more information.",
          "state_tools": [
            "go_home",
            "escalate_to_human"
          ],
          "transitions": [],
          "is_final": true
        },
        {
          "id": "cancelled",
          "name": "Application Cancelled",
          "agent_instructions": "The user cancelled their application. Acknowledge this and ask if there's anything else you can help with.",
          "state_tools": [
            "go_home"
          ],
          "transitions": [],
          "is_final": true
        }
      ]
    },
    {
      "id": "pay_snpl_flow",
      "name": "SNPL Payment",
      "trigger_description": "Triggered when user wants to make a payment on their SNPL loan",
      "initial_state": "select_loan",
      "data_schema": {
        "loan_id": {
          "type": "string",
          "description": "Selected loan ID"
        },
        "loan_balance": {
          "type": "number",
          "description": "Current loan balance"
        },
        "minimum_payment": {
          "type": "number",
          "description": "Minimum payment amount"
        },
        "payment_amount": {
          "type": "number",
          "description": "Amount user wants to pay"
        },
        "payment_method_id": {
          "type": "string",
          "description": "Selected payment method"
        }
      },
      "timeout_config": {
        "durationMinutes": 10,
        "onTimeout": "abandon",
        "reminderMessage": "Your payment is still in progress. Would you like to continue?"
      },
      "states": [
        {
          "id": "select_loan",
          "name": "Select Loan",
          "agent_instructions": "Call get_snpl_overview to see the user's active loans. If they have no active loans, inform them and exit. If they have one loan, proceed directly. If multiple loans, ask which one they want to pay.",
          "state_tools": [
            "get_snpl_overview",
            "list_loans"
          ],
          "transitions": [
            {
              "trigger": "loan_selected",
              "target": "choose_payment_amount"
            },
            {
              "trigger": "no_loans",
              "target": "no_active_loans"
            }
          ],
          "on_enter": {
            "message": "Let me check your active loans..."
          }
        },
        {
          "id": "choose_payment_amount",
          "name": "Choose Payment Amount",
          "agent_instructions": "Show the loan details (balance, weekly payment). Ask how much they want to pay. Offer options: 1) Minimum payment (weekly_payment), 2) Pay off full balance, 3) Custom amount. Validate the amount doesn't exceed the balance.",
          "state_tools": [
            "get_loan_details"
          ],
          "transitions": [
            {
              "trigger": "amount_selected",
              "target": "select_payment_method"
            }
          ]
        },
        {
          "id": "select_payment_method",
          "name": "Select Payment Method",
          "agent_instructions": "Ask the user which payment method they'd like to use. For this mock, we'll assume they have a default payment method on file. Confirm the payment method and proceed.",
          "state_tools": [],
          "transitions": [
            {
              "trigger": "method_selected",
              "target": "confirm_payment"
            }
          ]
        },
        {
          "id": "confirm_payment",
          "name": "Confirm Payment",
          "agent_instructions": "Show a summary of the payment: loan_id, amount to pay, payment method. Use make_snpl_payment to process. The tool has built-in confirmation.",
          "state_tools": [
            "make_snpl_payment"
          ],
          "transitions": [
            {
              "trigger": "payment_success",
              "target": "completed",
              "condition": "payment.success == true"
            },
            {
              "trigger": "payment_failed",
              "target": "error_state"
            },
            {
              "trigger": "user_cancels",
              "target": "cancelled"
            }
          ]
        },
        {
          "id": "completed",
          "name": "Payment Complete",
          "agent_instructions": "Payment was successful! Show the confirmation: payment amount, new balance, payments remaining. If the loan is now paid off, congratulate them. Ask if there's anything else they need.",
          "state_tools": [
            "go_home"
          ],
          "transitions": [],
          "is_final": true
        },
        {
          "id": "error_state",
          "name": "Payment Error",
          "agent_instructions": "There was an error processing the payment. Explain the issue and offer to try again or use a different payment method.",
          "state_tools": [
            "go_home",
            "escalate_to_human"
          ],
          "transitions": [
            {
              "trigger": "retry",
              "target": "choose_payment_amount"
            }
          ],
          "is_final": true
        },
        {
          "id": "no_active_loans",
          "name": "No Active Loans",
          "agent_instructions": "The user has no active SNPL loans to pay. Let them know and ask if they'd like to apply for one or need help with something else.",
          "state_tools": [
            "start_flow_apply_snpl",
            "go_home"
          ],
          "transitions": [],
          "is_final": true
        },
        {
          "id": "cancelled",
          "name": "Payment Cancelled",
          "agent_instructions": "The user cancelled the payment. Acknowledge and ask if there's anything else you can help with.",
          "state_tools": [
            "go_home"
          ],
          "transitions": [],
          "is_final": true
        }
      ]
    }
  ],
  "response_templates": [
    {
      "name": "SNPL Application Rejected",
      "trigger_config": {
        "type": "tool_error",
        "toolName": "submit_snpl_application"
      },
      "template": "We couldn't approve your SNPL application at this time.\n\n**Reason:** {reason}\n\nYou can try again later or contact our support team for more information.",
      "required_fields": [
        "reason"
      ],
      "enforcement": "mandatory"
    }
  ],
  "test_scenarios": [
    {
      "id": "snpl_eligibility_check",
      "name": "Check SNPL eligibility",
      "description": "User checks if they qualify for SNPL",
      "initial_context": {
        "user_id": "user_demo",
        "language": "es"
      },
      "turns": [
        {
          "user_input": "¿puedo obtener crédito?",
          "expected_behaviors": [
            {
              "type": "tool_called",
              "toolName": "get_snpl_eligibility"
            },
            {
              "type": "contains_any",
              "text": [
                "pre-aprobado",
                "elegible",
                "calificas",
                "$600"
              ]
            }
          ]
        }
      ],
      "success_criteria": {
        "no_escalation": true,
        "no_error_state": true
      },
      "tags": [
        "smoke",
        "eligibility"
      ],
      "enabled": true
    },
    {
      "id": "snpl_full_application",
      "name": "Complete SNPL application",
      "description": "User completes full SNPL application flow",
      "initial_context": {
        "user_id": "user_demo",
        "language": "es"
      },
      "turns": [
        {
          "user_input": "quiero solicitar snpl",
          "expected_behaviors": [
            {
              "type": "tool_called",
              "toolName": "start_flow_apply_snpl"
            }
          ]
        },
        {
          "user_input": "500 dólares",
          "expected_behaviors": [
            {
              "type": "contains_any",
              "text": [
                "semanas",
                "plazo",
                "término"
              ]
            }
          ]
        },
        {
          "user_input": "12 semanas",
          "expected_behaviors": [
            {
              "type": "contains_any",
              "text": [
                "confirmar",
                "resumen",
                "revisar"
              ]
            }
          ]
        },
        {
          "user_input": "sí, confirmo",
          "expected_behaviors": [
            {
              "type": "contains_any",
              "text": [
                "aprobado",
                "felicidades",
                "SNPL-"
              ]
            }
          ]
        }
      ],
      "success_criteria": {
        "no_escalation": true,
        "final_state": "completed"
      },
      "tags": [
        "happy-path",
        "application"
      ],
      "enabled": true
    },
    {
      "id": "snpl_make_payment",
      "name": "Make SNPL payment",
      "description": "User makes a payment on their SNPL loan",
      "initial_context": {
        "user_id": "user_demo",
        "language": "es"
      },
      "turns": [
        {
          "user_input": "quiero pagar mi préstamo",
          "expected_behaviors": [
            {
              "type": "tool_called",
              "toolName": "start_flow_pay_snpl"
            }
          ]
        }
      ],
      "success_criteria": {
        "no_escalation": true,
        "no_error_state": true
      },
      "tags": [
        "payment"
      ],
      "enabled": true
    },
    {
      "id": "snpl_check_status",
      "name": "Check SNPL status",
      "description": "User checks their SNPL loan status",
      "initial_context": {
        "user_id": "user_demo",
        "language": "es"
      },
      "turns": [
        {
          "user_input": "¿cuánto debo?",
          "expected_behaviors": [
            {
              "type": "tool_called",
              "toolName": "get_snpl_overview"
            },
            {
              "type": "contains_any",
              "text": [
                "saldo",
                "balance",
                "préstamo",
                "$"
              ]
            }
          ]
        }
      ],
      "success_criteria": {
        "no_escalation": true
      },
      "tags": [
        "status",
        "info"
      ],
      "enabled": true
    }
  ]
}
